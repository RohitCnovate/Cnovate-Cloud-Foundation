{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "7139539820760438973"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "openAiName": {
      "type": "string"
    },
    "enablePrivateEndpoint": {
      "type": "bool",
      "defaultValue": false
    },
    "subnetId": {
      "type": "string",
      "defaultValue": ""
    },
    "deployments": {
      "type": "array"
    },
    "logAnalyticsResourceGroup": {
      "type": "string",
      "defaultValue": ""
    },
    "logAnalyticsName": {
      "type": "string",
      "defaultValue": ""
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "openai-account",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('openAiName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "enablePrivateEndpoint": {
            "value": "[parameters('enablePrivateEndpoint')]"
          },
          "subnetId": {
            "value": "[parameters('subnetId')]"
          },
          "logAnalyticsResourceGroup": {
            "value": "[parameters('logAnalyticsResourceGroup')]"
          },
          "logAnalyticsName": {
            "value": "[parameters('logAnalyticsName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "5977143256560338802"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "enablePrivateEndpoint": {
              "type": "bool",
              "defaultValue": false
            },
            "subnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "logAnalyticsResourceGroup": {
              "type": "string",
              "defaultValue": ""
            },
            "logAnalyticsName": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2023-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "kind": "OpenAI",
              "sku": {
                "name": "S0"
              },
              "properties": {
                "customSubDomainName": "[parameters('name')]",
                "publicNetworkAccess": "[if(parameters('enablePrivateEndpoint'), 'Disabled', 'Enabled')]"
              }
            },
            {
              "condition": "[parameters('enablePrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}-pe', parameters('name'))]",
              "location": "[parameters('location')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "openai-connection",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]",
                      "groupIds": [
                        "account"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            },
            {
              "condition": "[not(equals(parameters('logAnalyticsName'), ''))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('name'))]",
              "name": "[format('{0}-diag', parameters('name'))]",
              "properties": {
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsResourceGroup'), parameters('logAnalyticsName'))]",
                "logs": [
                  {
                    "category": "Audit",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "openAiId": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
            },
            "openAiEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('name')), '2023-05-01').endpoint]"
            }
          }
        }
      }
    },
    {
      "copy": {
        "name": "openaiDeployments",
        "count": "[length(parameters('deployments'))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-{0}', parameters('deployments')[copyIndex()].deploymentName)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "openAiAccountName": {
            "value": "[parameters('openAiName')]"
          },
          "deploymentName": {
            "value": "[parameters('deployments')[copyIndex()].deploymentName]"
          },
          "modelName": {
            "value": "[parameters('deployments')[copyIndex()].modelName]"
          },
          "modelVersion": {
            "value": "[parameters('deployments')[copyIndex()].modelVersion]"
          },
          "capacity": {
            "value": "[parameters('deployments')[copyIndex()].capacity]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "1554339810221765157"
            }
          },
          "parameters": {
            "openAiAccountName": {
              "type": "string"
            },
            "deploymentName": {
              "type": "string"
            },
            "modelName": {
              "type": "string"
            },
            "modelVersion": {
              "type": "string"
            },
            "capacity": {
              "type": "int"
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('openAiAccountName'), parameters('deploymentName'))]",
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "[parameters('modelName')]",
                  "version": "[parameters('modelVersion')]"
                },
                "scaleSettings": {
                  "scaleType": "Standard",
                  "capacity": "[parameters('capacity')]"
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'openai-account')]"
      ]
    }
  ]
}